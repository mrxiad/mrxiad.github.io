---
title: es基本知识
date: 2024-4-11 19:33:12
tags: es
categories: 
- es
---



# Elasticsearch能做什么基本概念

- 为APP或网站增加搜索功能
- 存储和分析日志、指标和安全事件数据
- 使用机器学习实时自动建模数据的行为
- 使用Elasticsearch作为存储引擎自动化业务工作流
- 使用Elasticsearch作为地理信息系统（GIS）管理、集成和分析空间信息
- 使用Elasticsearch作为生物信息学研究工具存储和处理遗传数据



# Elasticsearch 架构与工作原理

### 架构概述

Elasticsearch 架构主要由三个组件构成：索引、分片和节点。

- 索引是文档的逻辑分组，类似于数据库中的表；
- 分片是索引的物理分区，用于提高数据分布和查询性能；
- 节点是运行 Elasticsearch 的服务器实例。



#### 工作原理

Elasticsearch 通过以下步骤完成搜索和分析任务：

1. 接收用户查询请求：Elasticsearch 通过 RESTful API 或 JSON 请求接收用户的查询请求。
2. 路由请求：接收到查询请求后，Elasticsearch 根据请求中的索引和分片信息将请求路由到相应的节点。
3. 执行查询：节点执行查询请求，并在相应的索引中查找匹配的文档。
4. 返回结果：查询结果以 JSON 格式返回给用户，包括匹配的文档和相关字段信息。





# Elasticsearch基本概念

## 索引（Index）

- **可以理解为数据库中的表**
- 索引是存储相关数据的数据结构。每个索引都有自己的映射（mapping），用于定义每个字段的数据类型和其他属性。

- 在创建索引时，我们需要指定一些参数，比如分片数量和副本数量。分片是将索引数据水平切分为多个小块的过程，这样可以提高数据检索和处理的效率。副本则是将索引数据复制到一个或多个节点上，以提高数据的可靠性和查询的可用性。
- 索引的映射（mapping）是用于定义索引中每个字段的数据类型和其他属性。在创建索引时，需要定义每个字段的数据类型（如文本、数字、日期等）和其他属性（如是否需要分析、是否存储等）。此外，映射还可以定义其他高级功能，如聚合、排序和过滤等。



## 类型（Type）

从Elasticsearch 7.x版本开始，索引中的每个文档都直接属于一个索引，而不再需要指定类型。这主要是为了简化索引和查询操作，提高查询效率。因此，在新的版本中，类型这个概念已经逐渐被淘汰。



## 文档（Document）

- **可以理解为数据库中的行**
- 文档是Elasticsearch中存储和检索的基本单位，它是序列化为JSON格式的数据结构。每个文档都有一个**唯一的标识符**，称为_id字段，用于唯一标识该文档。每个文档都存储在一个索引中，并且可以包含多个字段，这些字段可以是不同的数据类型，如文本、数字、日期等。

- 在Elasticsearch中，文档的属性包括`_index`、`_type`和`_source`等。`_index`表示文档所属的索引名称，`_type`表示文档所属的类型名称（在早期的Elasticsearch版本中，这是必需的，但在7.x版本之后已经不再需要），`_source`表示文档的原始JSON数据。





# Elasticsearch集群基本概念

## 集群（Cluster）

- 一个Elasticsearch集群通常包含了多个节点（Node）和一个或多个索引（Index），并且这些节点和索引共同构成了整个Elasticsearch集群，在所有节点上提供联合索引和搜索功能。

- 每个Cluster都有一个唯一的名称，即cluster name，它用于标识和区分不同的Elasticsearch集群。



## 节点（Node）

- 在Elasticsearch集群中，Node是指运行Elasticsearch实例的服务器。每个Node都有自己的名称和标识符，并且都有自己的数据存储和索引存储。

- 一个Elasticsearch集群由一个或多个Node组成，这些Node通过它们的集群名称进行标识。在默认情况下，如果Elasticsearch已经开始运行，它会自动生成一个叫做“elasticsearch”的集群。我们也可以在配置文件（elasticsearch.yml）中定制我们的集群名字。
- Node在Elasticsearch中扮演着不同的角色。根据节点的配置和功能，可以将Node分为以下几种类型：
	- Master Node：负责整个Cluster的配置和管理任务，如创建、更新和删除索引，添加或删除Node等。一个Cluster中至少需要有一个Master Node。
	- Data Node：主要负责数据的存储和处理，它们可以处理数据的CRUD操作、搜索操作、聚合操作等。一个Cluster中可以有多个Data Node。
	- Ingest Node：主要负责对文档进行预处理，如解析、转换、过滤等操作，然后再将文档写入到Index中。每个Cluster中至少需要有一个Ingest Node。 除了上述的三种类型外，还可以有Tribe Node、Remote Cluster Client等特殊用途的Node。
- Node之间是对等关系（去中心化），每个节点上面的集群状态数据都是实时同步的。如果Master节点出故障，按照预定的程序，其他一台Node机器会被选举成为新的Master。
- 需要注意的是，一个Node可以同时拥有一种或几种功能，如一个Node可以同时是Master Node和Data Node。



## 分片（Shards）

每个分片放到不同的服务器上。每个分片可以有零个或多个副本。这不仅能够提高查询效率，还能够提高系统的可靠性和可用性。如果某个节点或Shard发生故障，Elasticsearch可以从**其他节点或Shard的副本**中恢复数据，从而保证数据的可靠性和可用性。

> 对于每个索引，在创建时需要指定主分片的数量，一旦索引创建后，主分片的数量就不能更改。



## 副本（Replicas）

- 提高**系统的容错性**。当某个节点发生故障，或者某个分片（Shard）损坏或丢失时，可以从副本中恢复数据。这意味着，即使一个节点或分片出现问题，也不会导致整个索引的数据丢失。这种机制可以增加系统的可靠性，并减少因节点或分片故障导致的宕机时间。
- 提高**查询效率**。Elasticsearch会自动对搜索请求进行负载均衡，可以将搜索请求分配到多个节点上，从而并行处理搜索请求，提高查询效率。这种负载均衡机制可以在节点之间分发查询请求，使得每个节点都可以处理一部分查询请求，从而避免了一个节点的瓶颈效应。

> 副本可以在创建索引时或之后增加，提供了一种灵活的方式来根据需要调整系统的容错能力和读取性能。





# 搭建环境

```bash
docker-compose up
```



```yaml
version: "3.7"

services:
  elasticsearch:
    container_name: elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:8.9.1
    environment:
      - node.name=elasticsearch
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      - elastic
  kibana:
    image: docker.elastic.co/kibana/kibana:8.9.1
    container_name: kibana
    ports:
      - 5601:5601
    networks:
      - elastic
    depends_on:
      - elasticsearch

networks:
  elastic:
```

> 待容器启动后，在本机浏览器打开 [http://127.0.0.1:5601](http://127.0.0.1:5601/)即可看到如下kibana管理界面。







# 常用命令

## 查看健康状态

Kibana Dev Console输入以下命令：

```bash
GET /_cat/health?v
```



## 查询所有索引

```bash
GET /_cat/indices?v
```



## 创建索引

例如，下面的命令是在 Elasticsearch 集群创建一个名为`my-index`的新索引。

```bash
PUT /my-index
```

在创建索引时还可以指定以下内容：

- 索引的设置（setting）
- 索引中字段的映射（mapping）
- 索引别名（alias）

```bash
PUT /review-1
{
  "settings": {
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "id":{
        "type": "long"
      },
      "userID":{
        "type": "long"
      },
      "score":{
        "type": "integer"
      },
      "status":{
        "type": "integer"
      },
      "content":{
        "type": "text"
      },
      "publishTime":{
        "type": "date"
      },
      "tags":{
        "type": "nested",
        "properties": {
          "code":{
            "type": "keyword"
          },
          "title":{
            "type": "text"
          }
        }
      }
    }
  },
  "aliases": {
    "review_1": {}
  }
}
```



## 删除索引

```bash
DELETE /my-index
```



## 创建文档

将 JSON 文档添加到指定的数据流或索引并使其可搜索。如果目标是索引并且文档已经存在，则请求更新文档并递增其版本。

```bash
POST /review-1/_create/1
{
    "id":1,
    "userID":147982601,
    "score":5,
    "status":2,
    "publishTime":"2023-09-09T16:07:42.499144+08:00",
    "content":"这是一个好评！",
    "tags":[
        {
            "code":1000,
            "title":"好评"
        },
        {
            "code":2000,
            "title":"物超所值"
        },
        {
            "code":3000,
            "title":"有图"
        }
    ]
}
```



## 判断文档是否存在

```bash
HEAD /review-1/_doc/1
```

如果存在，Elasticsearch 返回 `200 - OK`的响应状态码，如果不存在则返回`404 - Not Found`。



## 获取文档

```go
GET /review-1/_doc/1
```

```bash
{
  "_index": "review-1",
  "_id": "1",
  "_version": 1,
  "_seq_no": 0,
  "_primary_term": 1,
  "found": true,
  "_source": {
    "id": 1,
    "userID": 147982601,
    "score": 5,
    "status": 2,
    "publishTime": "2023-09-09T16:07:42.499144+08:00",
    "content": "这是一个好评！",
    "tags": [
      {
        "code": 1000,
        "title": "好评"
      },
      {
        "code": 2000,
        "title": "物超所值"
      },
      {
        "code": 3000,
        "title": "有图"
      }
    ]
  }
}
```



## 获取数据

```bash
GET /review-1/_source/1
```

```bash
{
  "id": 1,
  "userID": 147982601,
  "score": 5,
  "status": 2,
  "publishTime": "2023-09-09T16:07:42.499144+08:00",
  "content": "这是一个好评！",
  "tags": [
    {
      "code": 1000,
      "title": "好评"
    },
    {
      "code": 2000,
      "title": "物超所值"
    },
    {
      "code": 3000,
      "title": "有图"
    }
  ]
}
```



## 获取指定字段

```bash
GET /review-1/_source/1?_source=content,score
```

```bash
{
  "score": 5,
  "content": "这是一个好评！"
}
```





## 更新文档

```bash
POST /review-1/_update/1
{
  "doc": {
    "content": "这是修改过的好评！"
  }
}
```

返回 `updated` 表示更新成功。

```bash
{
  "_index": "review-1",
  "_id": "1",
  "_version": 2,
  "result": "updated",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 8,
  "_primary_term": 1
}
```



## 批量获取

```bash
GET /review-1/_mget
{
  "docs":[
    {
      "_id":"1"
    },
    {
      "_id":"2"
    }
  ]
}

```

```bash
{
  "docs": [
    {
      "_index": "review-1",
      "_id": "1",
      "_version": 2,
      "_seq_no": 1,
      "_primary_term": 1,
      "found": true,
      "_source": {
        "id": 1,
        "userID": 147982601,
        "score": 5,
        "status": 2,
        "publishTime": "2023-09-09T16:07:42.499144+08:00",
        "content": "这是修改过的好评！",
        "tags": [
          {
            "code": 1000,
            "title": "好评"
          },
          {
            "code": 2000,
            "title": "物超所值"
          },
          {
            "code": 3000,
            "title": "有图"
          }
        ]
      }
    },
    {
      "_index": "review-1",
      "_id": "2",
      "found": false
    }
  ]
}
```





## 删除文档

```bash
DELETE /review-1/_doc/1
```

```bash
{
  "_index": "review-1",
  "_id": "1",
  "_version": 3,
  "result": "deleted",
  "_shards": {
    "total": 2,
    "successful": 1,
    "failed": 0
  },
  "_seq_no": 2,
  "_primary_term": 1
}
```



## 检索

返回与请求中定义的查询匹配的搜索结果。



### 查询`userID=147982601`的文档。

```bash
GET /review-1/_search
{
  "query": {
    "bool": {
      "filter":{
        "term":{"userID": 147982601}
      }
    }
  }
}
```



```bash
{
  "took": 5,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": 0,
    "hits": [
      {
        "_index": "review-1",
        "_id": "1",
        "_score": 0,
        "_source": {
          "id": 1,
          "userID": 147982601,
          "score": 5,
          "status": 2,
          "publishTime": "2023-09-09T16:07:42.499144+08:00",
          "content": "这是一个好评！",
          "tags": [
            {
              "code": 1000,
              "title": "好评"
            },
            {
              "code": 2000,
              "title": "物超所值"
            },
            {
              "code": 3000,
              "title": "有图"
            }
          ]
        }
      }
    ]
  }
}
```



### 查询`publishTime<=2023-09-09T16:20:00+08:00`的文档。

```bash
GET /review-1/_search
{
  "query": {
    "bool": {
      "filter": [
        {
          "range": {
            "publishTime": {
              "lte": "2023-09-09T16:20:00+08:00"
            }
          }
        }
      ]
    }
  }
}

```



### 查询`content`中包含`差评`的文档。

```bash
GET /review-1/_search
{
  "query": {
    "match_phrase": {
      "content": "差评"
    }
  }
}
```



## 获取数量

例如，查询`content`中包含`差评`的文档数量。

```bash
GET /review-1/_count
{
  "query": {
    "match_phrase": {
      "content": "差评"
    }
  }
}
```

```bash
{
  "count": 0,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  }
}
```



## 聚合

查询评价的平均分数。

```bash
POST /review-1/_search?size=0
{
  "aggs": {
    "avg_score": { "avg": { "field": "score"} }
  }
}
```

```bash
{
  "took": 11,
  "timed_out": false,
  "_shards": {
    "total": 1,
    "successful": 1,
    "skipped": 0,
    "failed": 0
  },
  "hits": {
    "total": {
      "value": 1,
      "relation": "eq"
    },
    "max_score": null,
    "hits": []
  },
  "aggregations": {
    "avg_score": {
      "value": 5
    }
  }
}
```

